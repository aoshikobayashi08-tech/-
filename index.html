<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>休業・営業時間案内 作成ツール（MVP）</title>
  <style>
    :root{
  --bg1:#f6f8fc;
  --bg2:#eef2ff;
  --card:#ffffff;
  --text:#0f172a;
  --muted:#64748b;
  --border:rgba(15,23,42,.10);
  --shadow: 0 10px 30px rgba(15,23,42,.08);
  --shadow2: 0 6px 18px rgba(15,23,42,.08);
  --radius: 16px;
  --primary:#2563eb;
  --primary2:#1d4ed8;
}

*{ box-sizing:border-box; }
html,body{ height:100%; }
body{
  margin:0;
  font-family: ui-sans-serif, system-ui, -apple-system, "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;
  color:var(--text);
  background: radial-gradient(1200px 600px at 20% 0%, var(--bg2), transparent),
              radial-gradient(1200px 600px at 80% 10%, #e0f2fe, transparent),
              linear-gradient(180deg, var(--bg1), #fff);
}

header{
  position: sticky; top:0; z-index:10;
  padding: 14px 18px;
  background: rgba(255,255,255,.78);
  backdrop-filter: blur(10px);
  border-bottom: 1px solid var(--border);
}

main{
  display:grid;
  grid-template-columns: 420px 1fr;
  gap: 18px;
  padding: 18px;
  max-width: 1180px;
  margin: 0 auto;
}
@media (max-width: 980px){
  main{ grid-template-columns:1fr; }
}

.card{
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 14px;
  box-shadow: var(--shadow2);
}

.card h2{
  font-size: 15px;
  margin: 0 0 10px;
  letter-spacing: .02em;
}

label{
  display:block;
  font-size: 12px;
  color: var(--muted);
  margin: 10px 0 6px;
}

input, select, textarea, button{
  width:100%;
  padding: 10px 12px;
  border-radius: 12px;
  border: 1px solid var(--border);
  background: #fff;
  font-size: 14px;
}

input:focus, select:focus, textarea:focus{
  outline: 3px solid rgba(37,99,235,.18);
  border-color: rgba(37,99,235,.35);
}

textarea{ min-height: 74px; resize: vertical; }

.row{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
.row3{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; }

button{
  cursor:pointer;
  border: none;
  background: linear-gradient(180deg, var(--primary), var(--primary2));
  color:#fff;
  font-weight: 700;
  box-shadow: var(--shadow2);
}
button:hover{ filter: brightness(1.03); }
button.secondary{
  background:#fff;
  color: var(--text);
  border: 1px solid var(--border);
  box-shadow: none;
}

.muted{ color: var(--muted); font-size: 12px; }

.pill{
  display:inline-block;
  padding: 3px 10px;
  border-radius: 999px;
  border: 1px solid var(--border);
  font-size: 12px;
  color: var(--muted);
  background: rgba(255,255,255,.7);
}

table{ width:100%; border-collapse: collapse; }
th, td{ border:1px solid var(--border); padding: 10px; vertical-align: top; }
th{ background: rgba(15,23,42,.03); font-weight: 800; }

.sheetWrap{ display:flex; justify-content:center; }
.sheet{
  width: 210mm; min-height: 297mm;
  background: white;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 16mm;
  box-shadow: var(--shadow);
}
.sheet h1{ font-size: 22px; margin: 0 0 6mm; }
.sheet .intro{ margin:0 0 6mm; line-height: 1.75; color: rgba(15,23,42,.92); }
.org{ display:flex; gap: 10px; flex-wrap: wrap; margin-bottom: 6mm; }
.org div{ font-size: 13px; color: var(--muted); }

@media print{
  header, .controls, .noPrint{ display:none !important; }
  body{ background:#fff; }
  main{ display:block; padding:0; max-width:none; }
  .card{ border:none; box-shadow:none; }
  .sheet{ border:none; border-radius:0; width:auto; min-height:auto; padding: 12mm; box-shadow:none; }
}

  </style>
</head>
<body>
<header>
  <strong>休業・営業時間案内 作成ツール（MVP）</strong>
  <span class="pill" style="margin-left:10px;">印刷 / PDF保存対応</span>
</header>

<main>
  <!-- Left controls -->
  <section class="controls">
    <div class="card">
      <h2>1. 医療機関種別</h2>
      <div class="row">
        <div>
          <label>種別</label>
          <select id="orgType">
            <option value="pharmacy">薬局</option>
            <option value="clinic">クリニック</option>
          </select>
        </div>
        <div>
          <label>主語</label>
          <select id="subjectPreset">
            <option value="auto">自動（種別に合わせる）</option>
            <option value="当院">当院</option>
            <option value="当薬局">当薬局</option>
            <option value="custom">任意入力</option>
          </select>
        </div>
      </div>
      <div id="subjectCustomWrap" style="display:none;">
        <label>任意の主語</label>
        <input id="subjectCustom" placeholder="例：〇〇薬局 / 〇〇クリニック" />
      </div>
    </div>

    <div class="card">
      <h2>2. 案内期間</h2>
      <div class="row">
        <div>
          <label>開始日</label>
          <input id="startDate" type="date" />
        </div>
        <div>
          <label>終了日</label>
          <input id="endDate" type="date" />
        </div>
      </div>
      <div style="margin-top:10px;" class="row">
        <button id="genDates">日付一覧を生成</button>
        <button class="secondary" id="clearDates">日付をクリア</button>
      </div>
      <p class="muted">※ 生成後、各日付の営業時間やメモ、文字色を編集できます。</p>
    </div>

    <div class="card">
      <h2>3. 医療機関情報</h2>
      <label>医療機関名</label>
      <input id="orgName" placeholder="例：〇〇薬局 / 〇〇クリニック" />
      <div class="row">
        <div>
          <label>代表電話番号</label>
          <input id="tel" placeholder="例：03-1234-5678" />
        </div>
        <div>
          <label>FAX番号</label>
          <input id="fax" placeholder="例：03-1234-5679" />
        </div>
      </div>
      <label>営業時間外の連絡先・案内</label>
      <textarea id="afterHours" placeholder="例：営業時間外は留守番電話をご利用ください。緊急時は〇〇へ…"></textarea>
    </div>

    <div class="card">
      <h2>4. タイトル・導入文</h2>
      <label>タイトルテンプレ</label>
      <select id="titleTpl"></select>
      <label>タイトル（編集可）</label>
      <input id="titleText" />

      <label style="margin-top:10px;">導入文テンプレ</label>
      <select id="introTpl"></select>
      <label>導入文（編集可）</label>
      <textarea id="introText"></textarea>
    </div>

    <div class="card">
      <h2>5. 掲示物</h2>
      <button id="render">掲示物を生成 / 更新</button>
      <div class="row" style="margin-top:10px;">
        <button id="printBtn">印刷する（PDF保存もここ）</button>
        <button class="secondary" id="saveLocal">入力を保存</button>
      </div>
      <p class="muted">※ PDF保存は、印刷ダイアログで「PDFに保存」を選択。</p>
    </div>
  </section>

  <!-- Right preview -->
  <section class="card">
    <h2 class="noPrint">プレビュー</h2>
    <div class="sheetWrap">
      <article class="sheet" id="preview">
        <h1 id="pTitle">（タイトル）</h1>
        <div class="org" id="pOrg"></div>
        <p class="intro" id="pIntro">（導入文）</p>

        <table>
          <thead>
            <tr>
              <th style="width: 28%;">日付</th>
              <th style="width: 30%;">営業時間 / 状態</th>
              <th>備考</th>
            </tr>
          </thead>
          <tbody id="pTableBody">
            <tr><td colspan="3" class="muted">左側で「日付一覧を生成」→編集→「掲示物を生成」</td></tr>
          </tbody>
        </table>
      </article>
    </div>

    <div class="card noPrint" style="margin-top:12px;">
      <h2>日付ごとの編集</h2>
      <div id="dateEditor" class="muted">日付を生成するとここに編集欄が出ます。</div>
    </div>
  </section>
</main>

<script>
  // ---------- Templates ----------
  const templates = {
    pharmacy: {
      titles: [
        "年末年始の営業時間のお知らせ",
        "ゴールデンウィーク期間中の開局時間のご案内",
        "お盆期間中の営業時間について",
        "臨時休業・営業時間変更のお知らせ",
      ],
      intros: [
        "平素より{SUBJECT}をご利用いただき、誠にありがとうございます。\n下記の期間、開局時間が通常と異なりますのでご案内いたします。",
        "いつも{SUBJECT}をご愛顧いただき、ありがとうございます。\n下記の期間の営業時間は以下の通りです。",
      ],
      defaultSubject: "当薬局",
    },
    clinic: {
      titles: [
        "年末年始の診療時間のお知らせ",
        "ゴールデンウィーク期間中の診療案内",
        "お盆期間中の診療時間について",
        "臨時休診・診療時間変更のお知らせ",
      ],
      intros: [
        "平素より{SUBJECT}をご利用いただき、誠にありがとうございます。\n下記の期間、診療時間が通常と異なりますのでご案内いたします。",
        "いつも{SUBJECT}をご愛顧いただき、ありがとうございます。\n下記の期間の診療時間は以下の通りです。",
      ],
      defaultSubject: "当院",
    }
  };

  // ---------- State ----------
  let dateRows = []; // {dateISO, status, note, color}
  const $ = (id) => document.getElementById(id);

  function formatJP(dateISO){
    const d = new Date(dateISO + "T00:00:00");
    const w = ["日","月","火","水","木","金","土"][d.getDay()];
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const da = String(d.getDate()).padStart(2,"0");
    return `${y}/${m}/${da}（${w}）`;
  }

  function getOrgKey(){
    return $("orgType").value === "clinic" ? "clinic" : "pharmacy";
  }

  function getSubject(){
    const preset = $("subjectPreset").value;
    const key = getOrgKey();
    if (preset === "auto") return templates[key].defaultSubject;
    if (preset === "custom") return ($("subjectCustom").value || templates[key].defaultSubject).trim();
    return preset;
  }

  function applyTemplates(){
    const key = getOrgKey();
    const t = templates[key];

    // Titles
    $("titleTpl").innerHTML = t.titles.map((x,i)=>`<option value="${i}">${x}</option>`).join("");
    $("titleText").value = t.titles[0];

    // Intros
    $("introTpl").innerHTML = t.intros.map((x,i)=>`<option value="${i}">${x.replaceAll("\n"," ")}</option>`).join("");
    $("introText").value = t.intros[0].replace("{SUBJECT}", getSubject());
  }

  function ensureIntroSubject(){
    const sub = getSubject();
    const raw = $("introText").value;
    // If template marker exists, replace; else keep user's free text
    if (raw.includes("{SUBJECT}")) {
      $("introText").value = raw.replaceAll("{SUBJECT}", sub);
    }
  }

  function buildDateRange(startISO, endISO){
    const s = new Date(startISO + "T00:00:00");
    const e = new Date(endISO + "T00:00:00");
    if (isNaN(s) || isNaN(e) || s > e) return [];
    const out = [];
    for (let d = new Date(s); d <= e; d.setDate(d.getDate() + 1)) {
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const da = String(d.getDate()).padStart(2,"0");
      out.push(`${y}-${m}-${da}`);
    }
    return out;
  }

  function renderDateEditor(){
    const wrap = $("dateEditor");
    if (!dateRows.length){
      wrap.className = "muted";
      wrap.textContent = "日付を生成するとここに編集欄が出ます。";
      return;
    }
    wrap.className = "";
    wrap.innerHTML = dateRows.map((r, idx) => `
      <div style="border:1px solid var(--border); border-radius:12px; padding:10px; margin-bottom:10px;">
        <div style="display:flex; justify-content:space-between; gap:10px; align-items:center;">
          <strong>${formatJP(r.dateISO)}</strong>
          <span class="pill">文字色</span>
        </div>

        <div class="row3" style="margin-top:8px;">
          <div>
            <label>営業時間 / 状態</label>
            <input data-idx="${idx}" data-k="status" value="${escapeHtml(r.status)}" placeholder="例：9:00-18:00 / 休業 / 午前のみ" />
          </div>
          <div>
            <label>備考</label>
            <input data-idx="${idx}" data-k="note" value="${escapeHtml(r.note)}" placeholder="例：処方受付は17:30まで" />
          </div>
          <div>
            <label>色</label>
            <select data-idx="${idx}" data-k="color">
              ${["#111111","red","blue","green","gray"].map(c => `
                <option value="${c}" ${r.color===c?"selected":""}>${c}</option>
              `).join("")}
            </select>
          </div>
        </div>
      </div>
    `).join("");

    wrap.querySelectorAll("input, select").forEach(el=>{
      el.addEventListener("input", (e)=>{
        const i = Number(e.target.dataset.idx);
        const k = e.target.dataset.k;
        dateRows[i][k] = e.target.value;
        // live preview update feels nice
        renderPreview();
      });
    });
  }

  function escapeHtml(s){
    return (s ?? "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");
  }

  function renderPreview(){
    const subject = getSubject();
    const orgName = $("orgName").value.trim();
    const tel = $("tel").value.trim();
    const fax = $("fax").value.trim();
    const afterHours = $("afterHours").value.trim();

    $("pTitle").textContent = $("titleText").value.trim() || "（タイトル）";

    const orgBits = [];
    if (orgName) orgBits.push(`<div><strong>${escapeHtml(orgName)}</strong></div>`);
    if (tel) orgBits.push(`<div>TEL：${escapeHtml(tel)}</div>`);
    if (fax) orgBits.push(`<div>FAX：${escapeHtml(fax)}</div>`);
    if (afterHours) orgBits.push(`<div>時間外：${escapeHtml(afterHours).replaceAll("\n","<br>")}</div>`);
    $("pOrg").innerHTML = orgBits.join("");

    const intro = ($("introText").value || "").replaceAll("{SUBJECT}", subject).trim();
    $("pIntro").innerHTML = escapeHtml(intro).replaceAll("\n","<br>");

    const body = $("pTableBody");
    if (!dateRows.length){
      body.innerHTML = `<tr><td colspan="3" class="muted">日付が未生成です。</td></tr>`;
      return;
    }
    body.innerHTML = dateRows.map(r => `
      <tr style="color:${escapeHtml(r.color)};">
        <td>${escapeHtml(formatJP(r.dateISO))}</td>
        <td>${escapeHtml(r.status || "")}</td>
        <td>${escapeHtml(r.note || "")}</td>
      </tr>
    `).join("");
  }

  function saveToLocal(){
    const payload = {
      orgType: $("orgType").value,
      subjectPreset: $("subjectPreset").value,
      subjectCustom: $("subjectCustom").value,
      startDate: $("startDate").value,
      endDate: $("endDate").value,
      orgName: $("orgName").value,
      tel: $("tel").value,
      fax: $("fax").value,
      afterHours: $("afterHours").value,
      titleText: $("titleText").value,
      introText: $("introText").value,
      dateRows,
    };
    localStorage.setItem("notice_mvp_v1", JSON.stringify(payload));
    alert("保存しました（このブラウザ内に保存）");
  }

  function loadFromLocal(){
    const raw = localStorage.getItem("notice_mvp_v1");
    if (!raw) return false;
    try {
      const p = JSON.parse(raw);
      $("orgType").value = p.orgType || "pharmacy";
      $("subjectPreset").value = p.subjectPreset || "auto";
      $("subjectCustom").value = p.subjectCustom || "";
      $("startDate").value = p.startDate || "";
      $("endDate").value = p.endDate || "";
      $("orgName").value = p.orgName || "";
      $("tel").value = p.tel || "";
      $("fax").value = p.fax || "";
      $("afterHours").value = p.afterHours || "";
      applyTemplates();
      $("titleText").value = p.titleText || $("titleText").value;
      $("introText").value = p.introText || $("introText").value;
      dateRows = Array.isArray(p.dateRows) ? p.dateRows : [];
      return true;
    } catch { return false; }
  }

  // ---------- Events ----------
  $("subjectPreset").addEventListener("change", ()=>{
    $("subjectCustomWrap").style.display = $("subjectPreset").value === "custom" ? "block" : "none";
    applyTemplates();
    renderPreview();
  });
  $("subjectCustom").addEventListener("input", ()=>{ ensureIntroSubject(); renderPreview(); });

  $("orgType").addEventListener("change", ()=>{
    applyTemplates();
    renderPreview();
  });

  $("titleTpl").addEventListener("change", (e)=>{
    const key = getOrgKey();
    $("titleText").value = templates[key].titles[Number(e.target.value)] || $("titleText").value;
    renderPreview();
  });
  $("introTpl").addEventListener("change", (e)=>{
    const key = getOrgKey();
    const sub = getSubject();
    const t = templates[key].intros[Number(e.target.value)] || $("introText").value;
    $("introText").value = t.replaceAll("{SUBJECT}", sub);
    renderPreview();
  });

  $("genDates").addEventListener("click", ()=>{
    const s = $("startDate").value;
    const e = $("endDate").value;
    const days = buildDateRange(s,e);
    if (!days.length){
      alert("開始日〜終了日を正しく入力してください。");
      return;
    }
    dateRows = days.map(d => ({
      dateISO: d,
      status: "",
      note: "",
      color: "#111111",
    }));
    renderDateEditor();
    renderPreview();
  });

  $("clearDates").addEventListener("click", ()=>{
    dateRows = [];
    renderDateEditor();
    renderPreview();
  });

  $("render").addEventListener("click", ()=>{
    ensureIntroSubject();
    renderDateEditor();
    renderPreview();
  });

  $("printBtn").addEventListener("click", ()=> window.print());
  $("saveLocal").addEventListener("click", saveToLocal);

  // Live updates for inputs
  ["orgName","tel","fax","afterHours","titleText","introText","startDate","endDate"].forEach(id=>{
    $(id).addEventListener("input", renderPreview);
  });

  // Init
  $("subjectCustomWrap").style.display = "none";
  applyTemplates();
  loadFromLocal();
  $("subjectCustomWrap").style.display = $("subjectPreset").value === "custom" ? "block" : "none";
  renderDateEditor();
  renderPreview();
</script>
</body>
</html>
